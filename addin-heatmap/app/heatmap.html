<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>FW Heatmap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@geotab/sdk@latest/dist/sdk.min.js"></script>
  <style>
    #map { height: 60vh; min-height: 320px; }
    .sidebar { padding: 1em; background: #f8f9fa; border-radius: 8px; box-shadow: 0 2px 8px #ddd; }
    .legend span { margin-right: 1em; }
    .ev-marker { color: #00bfff; }
    .low-battery-marker { color: #ff3333; }
    .charging-marker { color: #33ff33;}
    .fault-critical { color: #dc3545; }
    .fault-warning { color: #ffc107; }
    .fault-info { color: #0dcaf0; }
    .leaflet-popup-content { min-width: 180px; }
    .summary-list li { margin-bottom: 0.5em; }
    @media (max-width: 768px) {
      #map { height: 35vh; }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-md-12">
        <h2>FW Heatmap</h2>
        <div class="sidebar d-flex flex-wrap gap-2 align-items-center mb-2">
          <input type="date" id="startDate"/><input type="date" id="endDate"/>
          <select id="deviceSelect"><option>All Devices</option></select>
          <select id="evFilter">
            <option value="all">All</option>
            <option value="ev">EV Only</option>
            <option value="ice">ICE Only</option>
          </select>
          <select id="dataType">
            <option value="heatmap">Heatmap</option>
            <option value="battery">Battery Level</option>
            <option value="charging">Charging Events</option>
            <option value="faults">Faults</option>
            <option value="efficiency">Route Efficiency</option>
          </select>
          <button id="refreshBtn" class="btn btn-primary btn-sm">Refresh</button>
          <button id="exportBtn" class="btn btn-outline-secondary btn-sm">Export CSV</button>
          <button id="exportMapBtn" class="btn btn-outline-secondary btn-sm">Export Map</button>
        </div>
        <div class="legend">
          <strong>Legend:</strong>
          <span style="background: linear-gradient(to right, #00f, #ff0, #f00); padding: 0.3em 1em; border-radius: 6px;">Heatmap Intensity</span>
          <span style="color: #00bfff;">● EV Battery Point</span>
          <span style="color: #ff3333;">● Low Battery Event</span>
          <span style="color: #33ff33;">⚡ Charge Location</span>
          <span style="color: #dc3545;">● Critical Fault</span>
          <span style="color: #ffc107;">● Warning Fault</span>
          <span style="color: #0dcaf0;">● Info Fault</span>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-8">
        <div id="map"></div>
      </div>
      <div class="col-md-4">
        <div class="sidebar">
          <h4>Summary</h4>
          <ul class="summary-list" id="summaryStats">
            <li>Total charges: <span id="totalCharges">-</span></li>
            <li>Avg battery: <span id="avgBattery">-</span></li>
            <li>Low battery events: <span id="lowBatteryCount">-</span></li>
            <li>Faults: <span id="faultCount">-</span></li>
            <li>Critical Faults: <span id="faultCriticalCount">-</span></li>
            <li>Charging recommendations: <span id="chargingRecommendations">-</span></li>
            <li>EV vs ICE stats: <span id="evIceStats">-</span></li>
          </ul>
          <div id="faultList" style="max-height:150px;overflow-y:auto;"></div>
        </div>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);

    // Geotab SDK config
    const sdk = new geotab.sdk.API();
    let devices = [];
    let batteryEvents = [];
    let chargingEvents = [];
    let faults = [];

    async function authenticate() {
      // Geotab add-in is already authenticated inside MyGeotab, so you can use the parent context.
      // If developing externally, use sdk.authenticate({...}) with credentials.
      // For add-ins, use geotab.addin API if needed.
      // For demo, we'll fetch live objects.
      await fetchDevices();
      await fetchBatteryEvents();
      await fetchChargingEvents();
      await fetchFaults();
      renderDeviceOptions();
      renderMap();
      renderSummary();
    }

    async function fetchDevices() {
      // Fetch all devices
      devices = await sdk.call("Get", { typeName: "Device", search: {} });
    }

    async function fetchBatteryEvents() {
      // Fetch EV Battery Level records (Diagnostic id for battery varies; here is a common one)
      let batteryDiagnostic = await sdk.call("Get", { typeName: "Diagnostic", search: { code: "BatteryLevel" } });
      let diagnosticId = batteryDiagnostic[0] ? batteryDiagnostic[0].id : null;
      if (!diagnosticId) return;
      // Fetch status data for battery level for EVs only
      let statusData = await sdk.call("Get", { typeName: "StatusData", search: { diagnosticSearch: { id: diagnosticId } } });
      batteryEvents = statusData.map(sd => ({
        lat: sd.latitude,
        lng: sd.longitude,
        device: devices.find(d => d.id === sd.device.id)?.name || sd.device.id,
        level: sd.data,
        time: sd.dateTime,
        low: Number(sd.data) < 20 // Customize threshold
      })).filter(e => e.lat && e.lng);
    }

    async function fetchChargingEvents() {
      // Charging event diagnostic (varies by OEM)
      let chargingDiagnostic = await sdk.call("Get", { typeName: "Diagnostic", search: { code: "ChargingEvent" } });
      let diagnosticId = chargingDiagnostic[0] ? chargingDiagnostic[0].id : null;
      if (!diagnosticId) return;
      let statusData = await sdk.call("Get", { typeName: "StatusData", search: { diagnosticSearch: { id: diagnosticId } } });
      chargingEvents = statusData.map(sd => ({
        lat: sd.latitude,
        lng: sd.longitude,
        device: devices.find(d => d.id === sd.device.id)?.name || sd.device.id,
        time: sd.dateTime,
        station: sd.locationName || "Unknown"
      })).filter(e => e.lat && e.lng);
    }

    async function fetchFaults() {
      // Fetch fault data (DTCs)
      let faultData = await sdk.call("Get", { typeName: "FaultData", search: {} });
      faults = faultData.map(f => ({
        lat: f.latitude,
        lng: f.longitude,
        device: devices.find(d => d.id === f.device.id)?.name || f.device.id,
        code: f.diagnostic.code,
        description: f.diagnostic.description || "",
        severity: f.severity || "info",
        time: f.dateTime
      })).filter(f => f.lat && f.lng);
    }

    function renderDeviceOptions() {
      const sel = document.getElementById('deviceSelect');
      sel.innerHTML = '<option value="all">All Devices</option>';
      devices.forEach(d => {
        let type = d.vehicleIdentificationNumber && d.fuelType === "Electric" ? "ev" : "ice";
        sel.innerHTML += `<option value="${d.id}">${d.name} (${type.toUpperCase()})</option>`;
      });
    }

    function renderMap() {
      map.eachLayer(layer => { if (layer instanceof L.CircleMarker || layer instanceof L.Marker) map.removeLayer(layer); });
      // Battery events
      batteryEvents.forEach(e => {
        const color = e.low ? '#ff3333' : '#00bfff';
        const marker = L.circleMarker([e.lat, e.lng], { color, radius: 9, fillOpacity: 0.8 })
          .addTo(map)
          .bindPopup(
            `<b>${e.device}</b><br>Battery: ${e.level}%<br>Time: ${e.time}${e.low ? '<br><span style="color:red">Low Battery</span>' : ''}`
          );
      });
      // Charging events
      chargingEvents.forEach(e => {
        L.marker([e.lat, e.lng], { icon: L.divIcon({className: '', html: '<span style="color:#33ff33;font-size:1.5em;">⚡</span>'}) })
          .addTo(map)
          .bindPopup(`<b>${e.device}</b><br>Charged at: ${e.station}<br>Time: ${e.time}`);
      });
      // Faults
      faults.forEach(f => {
        let color = f.severity === 'critical' ? '#dc3545' : (f.severity === 'warning' ? '#ffc107' : '#0dcaf0');
        L.circleMarker([f.lat, f.lng], { color, radius: 10, fillOpacity: 0.7 })
          .addTo(map)
          .bindPopup(
            `<b>${f.device}</b><br>Fault: ${f.code}<br>${f.description}<br>Severity: <span style="color:${color}">${f.severity.toUpperCase()}</span><br>Time: ${f.time}`
          );
      });
      // Fit map to markers if any
      const allCoords = [
        ...batteryEvents.map(e => [e.lat, e.lng]),
        ...chargingEvents.map(e => [e.lat, e.lng]),
        ...faults.map(f => [f.lat, f.lng])
      ];
      if (allCoords.length) map.fitBounds(allCoords);
    }

    function renderSummary() {
      document.getElementById('totalCharges').textContent = chargingEvents.length;
      document.getElementById('avgBattery').textContent = (
        batteryEvents.reduce((a, b) => a + Number(b.level), 0) / (batteryEvents.length || 1)
      ).toFixed(1) + '%';
      document.getElementById('lowBatteryCount').textContent = batteryEvents.filter(e => e.low).length;
      document.getElementById('faultCount').textContent = faults.length;
      document.getElementById('faultCriticalCount').textContent = faults.filter(f => f.severity === 'critical').length;
      let evCount = devices.filter(d => d.vehicleIdentificationNumber && d.fuelType === "Electric").length;
      let iceCount = devices.filter(d => !d.vehicleIdentificationNumber || d.fuelType !== "Electric").length;
      document.getElementById('evIceStats').textContent = `EV: ${evCount} | ICE: ${iceCount}`;
      document.getElementById('chargingRecommendations').textContent =
        batteryEvents.filter(e => e.low).length > 0 ? 'Recommend charging at next opportunity.' : 'All EVs above threshold.';
      // Fault list
      let faultsList = faults.map(f =>
        `<div><b>${f.device}</b> [${f.code}] <span style="color:${f.severity === 'critical' ? '#dc3545' : (f.severity === 'warning' ? '#ffc107' : '#0dcaf0')}">${f.severity.toUpperCase()}</span><br>${f.description} (${f.time})</div>`
      ).join('');
      document.getElementById('faultList').innerHTML = faultsList;
    }

    function exportCSV() {
      let rows = [
        ['Type','Device','Lat','Lng','Time','Value','Description','Severity','Station']
      ];
      batteryEvents.forEach(e => rows.push(['Battery', e.device, e.lat, e.lng, e.time, e.level, e.low ? 'Low Battery' : '', '', '']));
      chargingEvents.forEach(e => rows.push(['Charge', e.device, e.lat, e.lng, e.time, '', '', '', e.station]));
      faults.forEach(f => rows.push(['Fault', f.device, f.lat, f.lng, f.time, f.code, f.description, f.severity, '']));
      let csv = rows.map(r => r.map(x => `"${x}"`).join(',')).join('\n');
      let a = document.createElement('a');
      a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
      a.download = 'fw_heatmap_export.csv';
      a.click();
    }

    function exportMapImage() {
      alert('Map export to image requires leaflet-image or similar. Integrate as needed.');
    }

    document.getElementById('exportBtn').onclick = exportCSV;
    document.getElementById('exportMapBtn').onclick = exportMapImage;
    document.getElementById('refreshBtn').onclick = authenticate;

    authenticate();
  </script>
</body>
</html>
